<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>QR Order - Menu</title>
  <style>
    body{font-family:Arial, sans-serif;margin:0;background:#f6f6f6}
    header{background:#111;color:#fff;padding:14px 16px;position:sticky;top:0}
    .wrap{max-width:980px;margin:0 auto;padding:16px}
    .row{display:flex;gap:12px;flex-wrap:wrap}
    .card{background:#fff;border-radius:12px;padding:12px;box-shadow:0 2px 10px rgba(0,0,0,.06);flex:1;min-width:260px}
    h2{margin:0 0 10px}
    .item{display:flex;justify-content:space-between;gap:10px;border-top:1px solid #eee;padding:10px 0}
    .item:first-child{border-top:none}
    button{border:none;border-radius:10px;padding:10px 12px;cursor:pointer}
    .btn{background:#1b7bff;color:#fff}
    .btn2{background:#111;color:#fff}
    .muted{color:#666;font-size:14px}
    textarea{width:100%;padding:10px;border:1px solid #ddd;border-radius:10px}
    .qty{display:flex;align-items:center;gap:8px}
    .pill{background:#eee;border-radius:999px;padding:4px 10px;font-size:12px}
  </style>
</head>
<body>
  <header>
    <div class="wrap" style="display:flex;justify-content:space-between;align-items:center;gap:10px;">
      <div>
        <div style="font-weight:700;">QR Order Menu</div>
        <div class="muted" id="tableText">Table: -</div>
      </div>
      <button class="btn2" onclick="scrollToCart()">Cart (<span id="cartCount">0</span>)</button>
    </div>
  </header>

  <div class="wrap">
    <div class="row">
      <div class="card">
        <h2>Menu</h2>
        <div class="muted">Tap “Add” to put items in cart.</div>
        <div id="menu"></div>
      </div>

      <div class="card" id="cartCard">
        <h2>Your Cart</h2>
        <div id="cart"></div>

        <div style="border-top:1px solid #eee; padding-top:12px; margin-top:12px;">
          <div style="display:flex; justify-content:space-between; font-weight:700;">
            <span>Total</span>
            <span>Rs <span id="total">0</span></span>
          </div>
        </div>

        <div style="margin-top:12px;">
          <label class="muted">Customer Note (optional)</label>
          <textarea id="note" rows="3" placeholder="No onions, less spicy..."></textarea>
        </div>

        <div style="margin-top:12px;">
          <button class="btn" style="width:100%;" onclick="placeOrder()">Place Order</button>
          <div id="msg" class="muted" style="margin-top:8px;"></div>
        </div>
      </div>
    </div>
  </div>

<script>
  const params = new URLSearchParams(location.search);
  const table = params.get("table") || "1";
  document.getElementById("tableText").textContent = "Table: " + table;

  let menuItems = [];
  let cart = {}; // name -> {name, price, qty}

  function money(n){ return Number(n||0).toFixed(0); }

  async function loadMenu(){
    const res = await fetch("/api/menu");
    menuItems = await res.json();

    const menuDiv = document.getElementById("menu");
    menuDiv.innerHTML = "";

    // group by category
    const groups = {};
    menuItems.forEach(it => {
      const c = it.category || "General";
      if(!groups[c]) groups[c] = [];
      groups[c].push(it);
    });

    Object.keys(groups).sort().forEach(cat => {
      const tag = document.createElement("div");
      tag.style.marginTop = "14px";
      tag.innerHTML = `<div class="pill">${cat}</div>`;
      menuDiv.appendChild(tag);

      groups[cat].forEach(it => {
        const row = document.createElement("div");
        row.className = "item";

        // avoid putting ${} inside PowerShell strings by building button via JS only
        row.innerHTML = `
          <div>
            <div style="font-weight:700">${it.name}</div>
            <div class="muted">Rs ${money(it.price)}</div>
          </div>
          <button class="btn">Add</button>
        `;
        row.querySelector("button").addEventListener("click", () => addToCart(it));
        menuDiv.appendChild(row);
      });
    });
  }

  function addToCart(it){
    const key = it.name;
    if(!cart[key]) cart[key] = { name: it.name, price: it.price, qty: 0 };
    cart[key].qty += 1;
    renderCart();
  }

  function changeQty(name, delta){
    if(!cart[name]) return;
    cart[name].qty += delta;
    if(cart[name].qty <= 0) delete cart[name];
    renderCart();
  }

  function renderCart(){
    const cartDiv = document.getElementById("cart");
    cartDiv.innerHTML = "";
    let count = 0;
    let total = 0;

    Object.values(cart).forEach(it => {
      count += it.qty;
      total += (Number(it.price)||0) * it.qty;

      const row = document.createElement("div");
      row.className = "item";
      row.innerHTML = `
        <div>
          <div style="font-weight:700">${it.name}</div>
          <div class="muted">Rs ${money(it.price)} x ${it.qty}</div>
        </div>
        <div class="qty">
          <button>-</button>
          <div style="min-width:18px;text-align:center;font-weight:700">${it.qty}</div>
          <button>+</button>
        </div>
      `;

      const btns = row.querySelectorAll("button");
      btns[0].addEventListener("click", () => changeQty(it.name, -1));
      btns[1].addEventListener("click", () => changeQty(it.name, 1));

      cartDiv.appendChild(row);
    });

    document.getElementById("cartCount").textContent = count;
    document.getElementById("total").textContent = money(total);

    if(count === 0){
      cartDiv.innerHTML = `<div class="muted" style="padding:10px 0;">Cart is empty.</div>`;
    }
  }

  function scrollToCart(){
    document.getElementById("cartCard").scrollIntoView({behavior:"smooth"});
  }

  async function placeOrder(){
    const items = Object.values(cart).map(x => ({ name:x.name, price:x.price, qty:x.qty }));
    const msg = document.getElementById("msg");
    msg.textContent = "";

    if(items.length === 0){
      msg.textContent = "Cart is empty.";
      return;
    }

    const customerNote = document.getElementById("note").value;

    const res = await fetch("/api/orders", {
      method:"POST",
      headers: {"Content-Type":"application/json"},
      body: JSON.stringify({ table, items, customerNote })
    });

    const data = await res.json();
    if(!res.ok){
      msg.textContent = data.error || "Order failed.";
      return;
    }

    cart = {};
    renderCart();
    document.getElementById("note").value = "";
    msg.textContent = "✅ Order placed! ID: " + data.orderId;
  }

  loadMenu();
  renderCart();
</script>
</body>
</html>
